---
layout:     post
title:      SUI Move 实战：共享对象版井字游戏从 0 到 1 全指南
date:       2025-09-05
header-img: img/post-bg-desk.jpg
catalog: true
---

> 关键字：Sui Move、井字游戏、共享对象、链上对战、Move合约、对象模型、游戏事件、奖杯NFT、实战教程、成本控制

## 1. 项目拆解：共享对象与井字游戏的完美结合

### 1.1 为什么选“共享对象”？

- **中心化痛点**：传统井字游戏把棋盘托管在管理员手中，每走一步都得两次交易，体验割裂。
- **共享对象优势**：TicTacToe 对象被声明为共享（`share_object`），两位玩家可在**单笔交易**内完成标记放置，真正实现“即时对战”。
- **成本权衡**：共享对象需要共识排序，但井字游戏天然“轮流落子”，高并发冲突低，Gas 价格波动可控。

👉 [体验链上井字游戏的丝滑交互，点此进入实战入口！](https://okxdog.com/)

### 1.2 核心数据结构

```move
struct TicTacToe has key {
    id: UID,
    gameboard: vector<vector<u8>>,
    cur_turn: u64,
    game_status: u8,
    x_address: address,
    o_address: address,
}
```

- `gameboard` 3×3 网格，0 为空，1 为 X，2 为 O。
- `game_status` 记录游戏进程：进行中、X 胜、O 胜、平局。
- `x_address`、`o_address` 绑定玩家身份，确保唯一回合检查。

## 2. 合约接口三步曲

### 2.1 create_game —— 开局

```move
public entry fun create_game(x_address: address, o_address: address, ctx: &mut TxContext)
```

- 任何地址（未来可拓展为管理员）调用即可开局。
- 关键代码行：`transfer::share_object(game)` 释放共享所有权。

> 避免误操作：建议通过前端限制仅能由游戏大厅创建。

### 2.2 place_mark —— 落子逻辑

```move
public entry fun place_mark(game: &mut TicTacToe, row: u8, col: u8, ctx: &mut TxContext)
```

安全检查四连击  
1️⃣ 坐标越界断言  
2️⃣ 只轮到对应玩家  
3️⃣ 禁止覆写已占格子  
4️⃣ 实时计算胜负并更新 `game_status`

终局触发：  
- `GameEndEvent` 发出后，索引器可自动清理数据结构。  
- 若存在胜者，立即铸造 `Trophy` 并空投给赢家地址。

### 2.3 delete_game —— 清扫棋盘

```move
public entry fun delete_game(game: TicTacToe)
```

- 当前实现**无权限控制**，任何人可销毁实例，释放链上空间。  
- 生产环境建议二次鉴权，仅允许两玩家或计时器合约进行清理。

## 3. 本地部署与测试脚本

### 3.1 账号环境速配

```bash
export ALICE=0x2d178b...82d19     # 玩家X
export BOB=0xf2e6ff...009f0       # 玩家O
export JASON=0x5c5882...569a      # 部署者
```

**一行搞定多角色地址切换**：  
使用 `sui client envs` + 临时 alias，无需反复导入私钥。

### 3.2 合约发布

```bash
# 以 JASON 身份
sui client publish --gas-budget 100000000
export PACKAGE_ID=<发布返回的 package_id>
```

记录关键对象 ID：

```bash
export GAME=<创建游戏对象的 object_id>
```

### 3.3 对局复现

| 回合 | 玩家 | 坐标 | 指令示例 | 场景描述 |
| --- | --- | --- | --- |
| 1 | Alice (X) | (0,0) | `place_mark $GAME 0 0` | 首子落中央偏左 |
| 2 | Bob (O)   | (1,2) | `place_mark $GAME 1 2` | 防守角位 |
| 3 | Alice (X) | (1,1) | `place_mark $GAME 1 1` | 斜线攻势 |
| 4 | Bob (O)   | (1,0) | `place_mark $GAME 1 0` | 封死一线 |
| 5 | Alice (X) | (2,2) | `place_mark $GAME 2 2` | 制胜三连 |

👉 [立即体验链上轮次推送，实时同步对战状态！](https://okxdog.com/)

每轮落子后执行：

```bash
sui client object $GAME
```

确认 `gameboard` 与 `game_status` 变动即可。

### 3.4 终局与奖杯

Alice 获得 `Trophy` 对象后，可用以下命令验证：

```bash
sui client object <trophy_object_id>
```

奖杯拥有者 `owner` 字段应为 `ALICE` 地址。

### 3.5 清理链上垃圾

```bash
sui client call --function delete_game --package $PACKAGE_ID --module shared_tic_tac_toe --args $GAME --gas-budget 10000000
```

## 4. 可拓展设计建议

### 4.1 UI 无人值守

- 监听 `GameEndEvent` 自动调用 `delete_game`，节省链上存储。
- 前端轮询，上次块高与当前块高差≥5 即清理。

### 4.2 盲盒 NFT 彩蛋

胜者额外获得随机皮肤 NFT，绑定至 Trophy 元数据，提升可玩性。

### 4.3 房间计时器

引入链上托管的 `TimerShared` 对象，30 秒未落子则对方强制胜利，避免挂机。

## 5. 常见问题 (FAQ)

**Q1：共享对象的 Gas 会比中心化对象高多少？**  
A：排序共识费取决于并发冲突度。井字游戏仅两玩家，但每次落子都会触发共享对象写入，实测 Gas 略高 ≈ **1.3 倍**，仍在毫厘级。

**Q2：如何防止玩家恶意连下两步？**  
A：`place_mark` 内 `addr == tx_context::sender` 与 `cur_turn` 校验已阻断此攻击。

**Q3：奖杯能否二次交易？**  
A：Trophy 限制为 `store`、`key`，默认可挂到任意 NFT 市场。若想纪念性质，可加 `drop` 能力避免流通。

**Q4：同一地址可否同时开多局？**  
A：当前逻辑允许，但后端需为每局生成独立 `GAME_ID`，建议前端用散列规则防重。

**Q5：如何给平局场景也颁发纪念 NFT？**  
A：在 `game_status == TIE` 分支里同时铸造 `TieBadge` 并空投给双方即可。

**Q6：万一有人在结束前调用了 `delete_game` 怎么办？**  
A：当前任何人可删，属于 Demo 设计。生产环境请增加 `assert!(sender == x_address || sender == o_address)` 或 DAO 权限判断。

---

紧握 Move 独特的对象模型，加上 Sui 的高吞吐，你已从 0 构建了一场完全去中心化的井字竞技。下一步，不妨把“五子棋”或“围棋小棋盘”搬进链上，让更多策略博弈和 DeFi 奖励结合，打开链游的新范式。